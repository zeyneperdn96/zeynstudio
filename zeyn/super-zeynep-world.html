<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Up: A Learning Journey</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-title {
            color: #ffd93d;
            font-size: 18px;
            margin-bottom: 12px;
            text-shadow: 2px 2px #000, 0 0 20px rgba(255, 217, 61, 0.3);
            letter-spacing: 1px;
        }

        .game-subtitle {
            color: #6bcb77;
            font-size: 10px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        #gameCanvas {
            border: 4px solid #4d4d4d;
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0,0,0,0.3);
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .hud {
            display: flex;
            gap: 30px;
            margin-top: 15px;
            color: #aaa;
            font-size: 10px;
        }

        .hud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .hud-value {
            color: #ffd93d;
            font-size: 14px;
        }

        .hud-label {
            font-size: 8px;
            opacity: 0.6;
        }

        .controls {
            margin-top: 20px;
            color: #555;
            font-size: 8px;
            letter-spacing: 1px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            text-align: center;
            color: #fff;
            max-width: 500px;
            padding: 40px;
        }

        .modal-content h2 {
            font-size: 24px;
            color: #ffd93d;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(255, 217, 61, 0.4);
        }

        .modal-content .subtitle {
            font-size: 10px;
            color: #6bcb77;
            margin-bottom: 30px;
        }

        .modal-content p {
            font-size: 10px;
            line-height: 2;
            margin-bottom: 20px;
            color: #aaa;
        }

        .start-text {
            color: #6bcb77;
            font-size: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .end-stats {
            margin: 30px 0;
            text-align: left;
            display: inline-block;
        }

        .end-stats div {
            font-size: 10px;
            color: #888;
            margin: 8px 0;
        }

        .end-stats span {
            color: #6bcb77;
        }

        .end-message {
            font-size: 12px;
            color: #ffd93d;
            margin: 30px 0;
            font-style: italic;
        }

        .btn-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .game-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            padding: 15px 25px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #6bcb77;
            color: #000;
        }

        .btn-secondary {
            background: transparent;
            color: #6bcb77;
            border: 2px solid #6bcb77;
        }

        .game-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(107, 203, 119, 0.4);
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <h1 class="game-title">LEVEL UP</h1>
        <p class="game-subtitle">A Learning Journey</p>
        <canvas id="gameCanvas" width="900" height="500"></canvas>
        <div class="hud">
            <div class="hud-item">
                <span class="hud-value" id="toolCount">0</span>
                <span class="hud-label">TOOLS</span>
            </div>
            <div class="hud-item">
                <span class="hud-value" id="skillCount">0</span>
                <span class="hud-label">SKILLS</span>
            </div>
            <div class="hud-item">
                <span class="hud-value" id="stageText">The Curious</span>
                <span class="hud-label">STAGE</span>
            </div>
        </div>
        <p class="controls">[ ← → ] MOVE &nbsp;&nbsp; [ SPACE ] JUMP &nbsp;&nbsp; [ R ] RESTART</p>
    </div>

    <!-- Start Modal -->
    <div class="modal" id="startModal">
        <div class="modal-content">
            <h2>LEVEL UP</h2>
            <p class="subtitle">A Learning Journey</p>
            <p>
                Collect tools and skills.<br>
                Grow a little each time.<br>
                There's no rush.
            </p>
            <p class="start-text">PRESS ENTER TO BEGIN</p>
        </div>
    </div>

    <!-- End Modal -->
    <div class="modal" id="endModal">
        <div class="modal-content">
            <h2>JOURNEY COMPLETE</h2>
            <div class="end-stats">
                <div>Tools collected: <span id="endTools">0</span></div>
                <div>Skills learned: <span id="endSkills">0</span></div>
                <div>Final stage: <span id="endStage">-</span></div>
            </div>
            <p class="end-message">"But the best part? You kept going."</p>
            <div class="btn-container">
                <button class="game-btn btn-primary" onclick="startGame()">START AGAIN</button>
                <a href="mailto:hello@zeynstudio.com" class="game-btn btn-secondary" style="text-decoration: none;">CONTACT ZEYNEP</a>
            </div>
        </div>
    </div>

    <!-- Growth Modal -->
    <div class="modal" id="growthModal">
        <div class="modal-content">
            <h2 id="growthStage">STAGE 2</h2>
            <p class="subtitle" id="growthTitle">"The Student"</p>
            <p id="growthMessage">Still figuring it out.</p>
        </div>
    </div>

    <script>
        // ========================================
        // LEVEL UP: A LEARNING JOURNEY
        // A humble pixel platformer about growth
        // ========================================

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width;
        const H = canvas.height;

        // ========================================
        // SPRITE ASSETS - Replace paths with your own sprites
        // ========================================

        // Player sprite - Replace with your pixel art character
        const playerSprite = new Image();
        playerSprite.src = 'assets/player-avatar.png'; // <-- REPLACE WITH YOUR SPRITE PATH

        // Question block sprites
        const questionBlockSprite = new Image();
        questionBlockSprite.src = 'assets/question-block.png'; // <-- Optional: Add your question block sprite

        const usedBlockSprite = new Image();
        usedBlockSprite.src = 'assets/used-block.png'; // <-- Optional: Add your used block sprite

        // Skill item sprites (placeholder - will use colored squares if not loaded)
        const skillItemSprites = {
            Pencil: null,    // Add: 'assets/pencil-icon.png'
            Notebook: null,  // Add: 'assets/notebook-icon.png'
            Coffee: null,    // Add: 'assets/coffee-icon.png'
            Cursor: null,    // Add: 'assets/cursor-icon.png'
            Figma: null,     // Add: 'assets/figma-icon.png'
            Blender: null,   // Add: 'assets/blender-icon.png'
            Code: null,      // Add: 'assets/code-icon.png'
            Camera: null,    // Add: 'assets/camera-icon.png'
            PenTool: null,   // Add: 'assets/pentool-icon.png'
            Curiosity: null, // Add: 'assets/curiosity-icon.png'
            Patience: null   // Add: 'assets/patience-icon.png'
        };

        // Track if player sprite is loaded
        let playerSpriteLoaded = false;
        playerSprite.onload = () => { playerSpriteLoaded = true; };
        playerSprite.onerror = () => { console.log('Player sprite not found, using fallback'); };

        // ========================================
        // GAME STATE
        // ========================================

        let gameStarted = false;
        let gameWon = false;
        let idleTime = 0;
        let showIdleText = false;
        let cameraX = 0;

        const LEVEL_WIDTH = 2800;

        document.getElementById('startModal').classList.add('active');

        // ========================================
        // PHYSICS - Tweaked for better feel
        // ========================================

        const GRAVITY = 0.55;
        const JUMP_POWER = -14.5;  // Increased from -13 for higher jumps
        const MOVE_SPEED = 4.5;
        const FRICTION = 0.85;

        // ========================================
        // GROWTH STAGES
        // ========================================

        const STAGES = [
            { name: 'The Curious', size: 1.0, required: 0 },
            { name: 'The Student', size: 1.2, required: 2 },
            { name: 'The Maker', size: 1.4, required: 4 },
            { name: 'The Builder', size: 1.6, required: 7 },
            { name: 'Still Learning', size: 1.8, required: 10 }
        ];

        // ========================================
        // COLLECTIBLE TYPES
        // ========================================

        const TOOLS = [
            { name: 'Pencil', color: '#ffd93d', message: 'Ideas start here.' },
            { name: 'Notebook', color: '#4d96ff', message: 'Notes taken.' },
            { name: 'Coffee', color: '#c4a484', message: 'Focus +1' },
            { name: 'Cursor', color: '#ffffff', message: 'Click by click.' }
        ];

        const SKILLS = [
            { name: 'Figma', color: '#a259ff', message: 'Layouts unlocked.' },
            { name: 'Blender', color: '#f5792a', message: 'Third dimension acquired.' },
            { name: 'Code', color: '#6bcb77', message: 'Logic installed.' },
            { name: 'Camera', color: '#ff6b6b', message: 'New perspective.' },
            { name: 'PenTool', color: '#4ecdc4', message: 'Curves ahead.' }
        ];

        const RARE = [
            { name: 'Curiosity', color: '#ffd93d', message: 'The best skill of all.', glow: true },
            { name: 'Patience', color: '#dda0dd', message: 'Good things take time.', glow: true }
        ];

        const IDLE_MESSAGES = [
            'Take your time.',
            'No rush here.',
            'The blocks aren\'t going anywhere.',
            'Rest is part of the journey.',
            'Still here. Still good.'
        ];

        // ========================================
        // PLAYER OBJECT
        // ========================================

        const player = {
            x: 80,
            y: 300,
            baseWidth: 32,
            baseHeight: 48,
            width: 32,
            height: 48,
            vx: 0,
            vy: 0,
            onGround: false,
            scale: 1,
            tools: 0,
            skills: 0,
            stage: 0,
            facingRight: true,
            totalCollected: 0,
            sparkles: [],
            animFrame: 0,
            animTimer: 0,

            reset() {
                this.x = 80;
                this.y = 300;
                this.vx = 0;
                this.vy = 0;
                this.scale = 1;
                this.tools = 0;
                this.skills = 0;
                this.stage = 0;
                this.totalCollected = 0;
                this.width = this.baseWidth;
                this.height = this.baseHeight;
                this.sparkles = [];
            },

            checkGrowth() {
                const total = this.tools + this.skills;
                for (let i = STAGES.length - 1; i >= 0; i--) {
                    if (total >= STAGES[i].required && this.stage < i) {
                        this.stage = i;
                        this.scale = STAGES[i].size;
                        this.width = this.baseWidth * this.scale;
                        this.height = this.baseHeight * this.scale;
                        this.y -= 20;
                        showGrowthModal(i);
                        return true;
                    }
                }
                return false;
            },

            // Draw player with sprite or fallback
            draw() {
                const x = this.x;
                const y = this.y;
                const w = this.width;
                const h = this.height;

                ctx.save();

                // Flip sprite if facing left
                if (!this.facingRight) {
                    ctx.translate(x + w, y);
                    ctx.scale(-1, 1);
                    ctx.translate(-x, -y);
                }

                // Draw shadow
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.beginPath();
                ctx.ellipse(x + w/2, y + h + 2, w * 0.4, 6, 0, 0, Math.PI * 2);
                ctx.fill();

                // Try to draw sprite, fallback to pixel art
                if (playerSpriteLoaded) {
                    // Draw loaded sprite image
                    ctx.drawImage(playerSprite, x, y, w, h);
                } else {
                    // Fallback: Draw pixel art character
                    this.drawFallbackCharacter(x, y, w, h);
                }

                ctx.restore();
            },

            drawFallbackCharacter(x, y, w, h) {
                // Body (coral/red shirt)
                ctx.fillStyle = '#ff6b6b';
                ctx.fillRect(x + w*0.2, y + h*0.35, w*0.6, h*0.35);

                // Head (skin)
                ctx.fillStyle = '#ffd8a8';
                ctx.fillRect(x + w*0.22, y + h*0.08, w*0.56, h*0.3);

                // Hair (ginger/red)
                ctx.fillStyle = '#c75b39';
                ctx.fillRect(x + w*0.18, y + h*0.02, w*0.64, h*0.15);
                ctx.fillRect(x + w*0.15, y + h*0.08, w*0.2, h*0.25);
                ctx.fillRect(x + w*0.65, y + h*0.08, w*0.2, h*0.25);
                // Long hair sides
                ctx.fillRect(x + w*0.1, y + h*0.2, w*0.15, h*0.35);
                ctx.fillRect(x + w*0.75, y + h*0.2, w*0.15, h*0.35);

                // Glasses
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(x + w*0.28, y + h*0.18, w*0.18, h*0.1);
                ctx.strokeRect(x + w*0.54, y + h*0.18, w*0.18, h*0.1);
                ctx.beginPath();
                ctx.moveTo(x + w*0.46, y + h*0.22);
                ctx.lineTo(x + w*0.54, y + h*0.22);
                ctx.stroke();

                // Eyes behind glasses
                ctx.fillStyle = '#5a3825';
                ctx.fillRect(x + w*0.33, y + h*0.2, w*0.08, h*0.05);
                ctx.fillRect(x + w*0.59, y + h*0.2, w*0.08, h*0.05);

                // Smile
                ctx.fillStyle = '#d4a574';
                ctx.fillRect(x + w*0.4, y + h*0.32, w*0.2, h*0.03);

                // Grey turtleneck
                ctx.fillStyle = '#888';
                ctx.fillRect(x + w*0.2, y + h*0.35, w*0.6, h*0.38);
                ctx.fillStyle = '#999';
                ctx.fillRect(x + w*0.28, y + h*0.35, w*0.44, h*0.08);

                // Backpack (stage 2+)
                if (this.stage >= 1) {
                    ctx.fillStyle = '#4a7c59';
                    ctx.fillRect(x + w*0.02, y + h*0.4, w*0.18, h*0.28);
                    ctx.fillStyle = '#3d6b4a';
                    ctx.fillRect(x + w*0.05, y + h*0.45, w*0.12, h*0.08);
                }

                // Tool in hand (stage 3+)
                if (this.stage >= 2) {
                    ctx.fillStyle = '#ffd93d';
                    ctx.fillRect(x + w*0.78, y + h*0.45, w*0.12, h*0.18);
                }

                // Pants
                ctx.fillStyle = '#4a6fa5';
                ctx.fillRect(x + w*0.25, y + h*0.7, w*0.5, h*0.18);

                // Shoes
                ctx.fillStyle = '#333';
                ctx.fillRect(x + w*0.22, y + h*0.86, w*0.22, h*0.12);
                ctx.fillRect(x + w*0.56, y + h*0.86, w*0.22, h*0.12);
            }
        };

        // ========================================
        // INPUT HANDLING
        // ========================================

        const keys = {};
        document.addEventListener('keydown', e => {
            keys[e.code] = true;
            idleTime = 0;
            showIdleText = false;

            if (e.code === 'Enter') {
                if (!gameStarted || gameWon) {
                    startGame();
                }
            }
            if (e.code === 'KeyR' && gameStarted) {
                startGame();
            }
            if (e.code === 'Space') e.preventDefault();
        });
        document.addEventListener('keyup', e => keys[e.code] = false);

        // ========================================
        // LEVEL DESIGN - Redesigned for better flow
        // ========================================

        const platforms = [
            // Ground sections with gaps
            { x: 0, y: 450, w: 350, h: 50, type: 'ground' },
            { x: 420, y: 450, w: 280, h: 50, type: 'ground' },
            { x: 780, y: 450, w: 350, h: 50, type: 'ground' },
            { x: 1200, y: 450, w: 400, h: 50, type: 'ground' },
            { x: 1700, y: 450, w: 350, h: 50, type: 'ground' },
            { x: 2150, y: 450, w: 650, h: 50, type: 'ground' },

            // Stage 1 - Easy platforms (low height)
            { x: 150, y: 370, w: 100, h: 22, type: 'brick' },
            { x: 300, y: 320, w: 80, h: 22, type: 'brick' },

            // Stage 2 - Medium platforms
            { x: 500, y: 360, w: 120, h: 22, type: 'brick' },
            { x: 680, y: 300, w: 100, h: 22, type: 'brick' },

            // Stage 3 - Higher platforms
            { x: 880, y: 350, w: 100, h: 22, type: 'brick' },
            { x: 1020, y: 290, w: 120, h: 22, type: 'brick' },
            { x: 1180, y: 230, w: 80, h: 22, type: 'brick' },

            // Stage 4 - Challenging section
            { x: 1350, y: 360, w: 100, h: 22, type: 'brick' },
            { x: 1500, y: 300, w: 100, h: 22, type: 'brick' },
            { x: 1650, y: 240, w: 100, h: 22, type: 'brick' },
            { x: 1820, y: 180, w: 100, h: 22, type: 'brick' },

            // Final stretch
            { x: 2000, y: 350, w: 120, h: 22, type: 'brick' },
            { x: 2180, y: 290, w: 100, h: 22, type: 'brick' },
            { x: 2350, y: 230, w: 100, h: 22, type: 'brick' },
            { x: 2520, y: 300, w: 150, h: 22, type: 'brick' },
        ];

        // Question blocks - positioned for hitting from below
        const questionBlocks = [
            // Tools
            { x: 170, y: 300, w: 40, h: 40, hit: false, itemType: 'tool', item: TOOLS[0], bounceY: 0 },
            { x: 520, y: 290, w: 40, h: 40, hit: false, itemType: 'tool', item: TOOLS[1], bounceY: 0 },
            { x: 900, y: 280, w: 40, h: 40, hit: false, itemType: 'tool', item: TOOLS[2], bounceY: 0 },
            { x: 1370, y: 290, w: 40, h: 40, hit: false, itemType: 'tool', item: TOOLS[3], bounceY: 0 },

            // Skills
            { x: 320, y: 250, w: 40, h: 40, hit: false, itemType: 'skill', item: SKILLS[0], bounceY: 0 },
            { x: 700, y: 230, w: 40, h: 40, hit: false, itemType: 'skill', item: SKILLS[1], bounceY: 0 },
            { x: 1040, y: 220, w: 40, h: 40, hit: false, itemType: 'skill', item: SKILLS[2], bounceY: 0 },
            { x: 1520, y: 230, w: 40, h: 40, hit: false, itemType: 'skill', item: SKILLS[3], bounceY: 0 },
            { x: 1840, y: 110, w: 40, h: 40, hit: false, itemType: 'skill', item: SKILLS[4], bounceY: 0 },

            // Rare items (glowing)
            { x: 1200, y: 160, w: 40, h: 40, hit: false, itemType: 'rare', item: RARE[0], bounceY: 0 },
            { x: 2200, y: 220, w: 40, h: 40, hit: false, itemType: 'rare', item: RARE[1], bounceY: 0 },
        ];

        // End door
        const endDoor = { x: 2650, y: 350, w: 60, h: 100 };

        // Spawned items (from question blocks)
        let spawnedItems = [];
        let floatingTexts = [];
        let particles = [];

        // Clouds
        const clouds = [];
        for (let i = 0; i < 20; i++) {
            clouds.push({
                x: Math.random() * LEVEL_WIDTH,
                y: 20 + Math.random() * 120,
                size: 0.4 + Math.random() * 0.8,
                speed: 0.15 + Math.random() * 0.35
            });
        }

        // ========================================
        // AUDIO SYSTEM
        // ========================================

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(freq, duration, type = 'square', volume = 0.08) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function jumpSound() {
            playSound(280, 0.1, 'sine');
            setTimeout(() => playSound(380, 0.1, 'sine'), 40);
        }

        function bumpSound() {
            playSound(180, 0.08, 'square');
            setTimeout(() => playSound(220, 0.1, 'square'), 30);
        }

        function collectSound(isRare = false) {
            if (isRare) {
                playSound(523, 0.12, 'sine');
                setTimeout(() => playSound(659, 0.12, 'sine'), 80);
                setTimeout(() => playSound(784, 0.25, 'sine'), 160);
            } else {
                playSound(880, 0.08, 'sine');
                setTimeout(() => playSound(1100, 0.15, 'sine'), 60);
            }
        }

        function growSound() {
            playSound(440, 0.15, 'sine');
            setTimeout(() => playSound(554, 0.15, 'sine'), 120);
            setTimeout(() => playSound(659, 0.25, 'sine'), 240);
        }

        // ========================================
        // GAME FUNCTIONS
        // ========================================

        function showGrowthModal(stageIndex) {
            const stage = STAGES[stageIndex];
            document.getElementById('growthStage').textContent = `STAGE ${stageIndex + 1}`;
            document.getElementById('growthTitle').textContent = `"${stage.name}"`;

            const messages = [
                'Just getting started.',
                'Still figuring it out.',
                'Making things now.',
                'Building with purpose.',
                'Always will be.'
            ];
            document.getElementById('growthMessage').textContent = messages[stageIndex];

            document.getElementById('growthModal').classList.add('active');
            growSound();

            setTimeout(() => {
                document.getElementById('growthModal').classList.remove('active');
            }, 1800);
        }

        function startGame() {
            document.getElementById('startModal').classList.remove('active');
            document.getElementById('endModal').classList.remove('active');
            document.getElementById('growthModal').classList.remove('active');
            gameStarted = true;
            gameWon = false;
            player.reset();
            questionBlocks.forEach(b => { b.hit = false; b.bounceY = 0; });
            spawnedItems = [];
            floatingTexts = [];
            particles = [];
            cameraX = 0;
            idleTime = 0;
            updateHUD();
        }

        function updateHUD() {
            document.getElementById('toolCount').textContent = player.tools;
            document.getElementById('skillCount').textContent = player.skills;
            document.getElementById('stageText').textContent = STAGES[player.stage].name;
        }

        function collides(a, b) {
            return a.x < b.x + b.w &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.h &&
                   a.y + a.height > b.y;
        }

        // Spawn item from block (moves up then falls)
        function spawnItemFromBlock(block) {
            spawnedItems.push({
                x: block.x + 5,
                y: block.y,
                w: 30,
                h: 30,
                vy: -5,  // Initial upward velocity
                phase: 'rising', // 'rising' or 'falling'
                riseTarget: block.y - 45,
                ...block.item,
                type: block.itemType,
                bounceCount: 0
            });
        }

        function addFloatText(x, y, text, color = '#fff') {
            floatingTexts.push({ x, y, text, color, life: 100, startY: y });
        }

        function addParticles(x, y, color, count = 10) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8 - 3,
                    life: 35 + Math.random() * 25,
                    color,
                    size: 3 + Math.random() * 5
                });
            }
        }

        // ========================================
        // UPDATE LOOP
        // ========================================

        function update() {
            if (!gameStarted || gameWon) return;

            // Idle timer
            if (!keys['ArrowLeft'] && !keys['ArrowRight'] && !keys['Space']) {
                idleTime++;
                if (idleTime > 600) showIdleText = true;
            }

            // Player movement with acceleration
            if (keys['ArrowLeft']) {
                player.vx = Math.max(player.vx - 0.5, -MOVE_SPEED);
                player.facingRight = false;
            } else if (keys['ArrowRight']) {
                player.vx = Math.min(player.vx + 0.5, MOVE_SPEED);
                player.facingRight = true;
            } else {
                player.vx *= FRICTION;
                if (Math.abs(player.vx) < 0.3) player.vx = 0;
            }

            // Jump - only when on ground
            if ((keys['Space'] || keys['ArrowUp']) && player.onGround) {
                player.vy = JUMP_POWER;
                player.onGround = false;
                jumpSound();
            }

            // Gravity
            player.vy += GRAVITY;
            if (player.vy > 16) player.vy = 16;

            // Move player
            player.x += player.vx;
            player.y += player.vy;

            // Boundaries
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > LEVEL_WIDTH) player.x = LEVEL_WIDTH - player.width;

            // Camera follow (smooth)
            const targetCam = player.x - W / 3;
            cameraX += (targetCam - cameraX) * 0.1;
            if (cameraX < 0) cameraX = 0;
            if (cameraX > LEVEL_WIDTH - W) cameraX = LEVEL_WIDTH - W;

            // Platform collision
            player.onGround = false;

            for (let p of platforms) {
                const pRect = { x: p.x, y: p.y, w: p.w, h: p.h };

                if (collides(player, pRect)) {
                    // Landing on top
                    if (player.vy > 0 && player.y + player.height - player.vy <= p.y + 8) {
                        player.y = p.y - player.height;
                        player.vy = 0;
                        player.onGround = true;
                    }
                    // Hitting from below
                    else if (player.vy < 0 && player.y - player.vy >= p.y + p.h - 8) {
                        player.y = p.y + p.h;
                        player.vy = 2;
                    }
                    // Side collision
                    else {
                        if (player.vx > 0) player.x = p.x - player.width;
                        else if (player.vx < 0) player.x = p.x + p.w;
                        player.vx = 0;
                    }
                }
            }

            // Question block collision - HIT FROM BELOW ONLY
            for (let block of questionBlocks) {
                if (!block.hit) {
                    const bx = block.x, by = block.y + block.bounceY;
                    const bw = block.w, bh = block.h;

                    // Check if player is hitting from below
                    const playerTop = player.y;
                    const playerBottom = player.y + player.height;
                    const blockBottom = by + bh;

                    // Must be moving upward and head hits bottom of block
                    if (player.vy < 0 &&
                        player.x + player.width > bx + 5 &&
                        player.x < bx + bw - 5 &&
                        playerTop <= blockBottom &&
                        playerTop >= blockBottom - 18 &&
                        playerBottom > by) {

                        // Hit the block!
                        block.hit = true;
                        block.bounceY = -8; // Block bounce animation
                        player.vy = 3; // Bounce player down
                        bumpSound();

                        // Spawn item from block
                        spawnItemFromBlock(block);
                    }
                }

                // Animate block bounce
                if (block.bounceY < 0) {
                    block.bounceY += 2;
                    if (block.bounceY > 0) block.bounceY = 0;
                }
            }

            // Update spawned items
            for (let item of spawnedItems) {
                if (item.phase === 'rising') {
                    item.y += item.vy;
                    item.vy += 0.3;
                    if (item.y <= item.riseTarget || item.vy >= 0) {
                        item.phase = 'falling';
                        item.vy = 0;
                    }
                } else {
                    // Falling phase with gravity
                    item.vy += 0.35;
                    item.y += item.vy;

                    // Bounce on platforms
                    for (let p of platforms) {
                        if (item.y + item.h >= p.y && item.y + item.h <= p.y + 20 &&
                            item.x + item.w > p.x && item.x < p.x + p.w && item.vy > 0) {
                            item.y = p.y - item.h;
                            if (item.bounceCount < 2) {
                                item.vy = -4;
                                item.bounceCount++;
                            } else {
                                item.vy = 0;
                            }
                        }
                    }
                }

                // Collect item when player touches it
                if (collides(player, { x: item.x, y: item.y, w: item.w, h: item.h })) {
                    if (item.type === 'tool') player.tools++;
                    else if (item.type === 'skill') player.skills++;
                    else if (item.type === 'rare') player.skills++;

                    player.totalCollected++;
                    collectSound(item.type === 'rare');
                    addFloatText(item.x, item.y - 25, item.message, item.color);
                    addParticles(item.x + 15, item.y + 15, item.color, item.glow ? 18 : 10);
                    item.collected = true;

                    player.checkGrowth();
                    updateHUD();
                }
            }

            // Remove collected/fallen items
            spawnedItems = spawnedItems.filter(i => !i.collected && i.y < H + 100);

            // Update floating texts
            floatingTexts = floatingTexts.filter(t => {
                t.y -= 0.6;
                t.life--;
                return t.life > 0;
            });

            // Update particles
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2;
                p.life--;
                return p.life > 0;
            });

            // Sparkles for max stage
            if (player.stage >= 4 && Math.random() < 0.4) {
                player.sparkles.push({
                    x: player.x + Math.random() * player.width,
                    y: player.y + player.height,
                    life: 25
                });
            }
            player.sparkles = player.sparkles.filter(s => {
                s.life--;
                s.y += 0.8;
                return s.life > 0;
            });

            // End door collision
            if (collides(player, { x: endDoor.x, y: endDoor.y, w: endDoor.w, h: endDoor.h })) {
                gameWon = true;
                document.getElementById('endTools').textContent = player.tools;
                document.getElementById('endSkills').textContent = player.skills;
                document.getElementById('endStage').textContent = STAGES[player.stage].name;
                document.getElementById('endModal').classList.add('active');
            }

            // Fall off screen - respawn
            if (player.y > H + 100) {
                player.y = 300;
                player.x = Math.max(80, cameraX + 80);
                player.vy = 0;
            }
        }

        // ========================================
        // DRAW LOOP
        // ========================================

        function draw() {
            // Sky gradient (twilight)
            const sky = ctx.createLinearGradient(0, 0, 0, H);
            sky.addColorStop(0, '#1a0a2e');
            sky.addColorStop(0.4, '#3d2366');
            sky.addColorStop(0.7, '#6b4a8a');
            sky.addColorStop(1, '#9d7bb5');
            ctx.fillStyle = sky;
            ctx.fillRect(0, 0, W, H);

            // Stars
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 60; i++) {
                const sx = (i * 73 + cameraX * 0.05) % W;
                const sy = (i * 47) % 180;
                const size = (i % 3) + 1;
                ctx.fillRect(sx, sy, size, size);
            }

            // Clouds (parallax)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.12)';
            for (let c of clouds) {
                const cx = (c.x - cameraX * c.speed + LEVEL_WIDTH) % (LEVEL_WIDTH + 200) - 100;
                if (cx > -150 && cx < W + 150) {
                    drawCloud(cx, c.y, c.size);
                }
            }

            ctx.save();
            ctx.translate(-cameraX, 0);

            // Draw platforms
            for (let p of platforms) {
                if (p.x + p.w > cameraX - 50 && p.x < cameraX + W + 50) {
                    if (p.type === 'ground') {
                        drawGround(p);
                    } else {
                        drawBrick(p);
                    }
                }
            }

            // Draw question blocks
            for (let block of questionBlocks) {
                if (block.x > cameraX - 50 && block.x < cameraX + W + 50) {
                    drawQuestionBlock(block);
                }
            }

            // Draw end door
            drawEndDoor();

            // Draw spawned items
            for (let item of spawnedItems) {
                drawSpawnedItem(item);
            }

            // Draw player sparkles
            ctx.fillStyle = '#ffd93d';
            for (let s of player.sparkles) {
                ctx.globalAlpha = s.life / 25;
                ctx.fillRect(s.x - 2, s.y - 2, 4, 4);
            }
            ctx.globalAlpha = 1;

            // Draw player
            player.draw();

            // Draw particles
            for (let p of particles) {
                ctx.globalAlpha = p.life / 60;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
            }
            ctx.globalAlpha = 1;

            // Draw floating texts
            ctx.font = '10px "Press Start 2P"';
            ctx.textAlign = 'center';
            for (let t of floatingTexts) {
                ctx.globalAlpha = Math.min(t.life / 50, 1);
                ctx.fillStyle = '#000';
                ctx.fillText(t.text, t.x + 17, t.y + 2);
                ctx.fillStyle = t.color;
                ctx.fillText(t.text, t.x + 15, t.y);
            }
            ctx.globalAlpha = 1;

            ctx.restore();

            // Idle text
            if (showIdleText && gameStarted && !gameWon) {
                ctx.font = '10px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.35)';
                const msg = IDLE_MESSAGES[Math.floor(Date.now() / 4000) % IDLE_MESSAGES.length];
                ctx.fillText(msg, W / 2, 35);
            }
        }

        // ========================================
        // DRAW HELPER FUNCTIONS
        // ========================================

        function drawCloud(x, y, scale) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            ctx.beginPath();
            ctx.arc(0, 20, 28, 0, Math.PI * 2);
            ctx.arc(35, 12, 35, 0, Math.PI * 2);
            ctx.arc(70, 20, 28, 0, Math.PI * 2);
            ctx.arc(35, 32, 28, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function drawGround(p) {
            // Dirt
            ctx.fillStyle = '#4a3f35';
            ctx.fillRect(p.x, p.y, p.w, p.h);

            // Grass top
            ctx.fillStyle = '#5a8f5a';
            ctx.fillRect(p.x, p.y, p.w, 14);
            ctx.fillStyle = '#7ab87a';
            ctx.fillRect(p.x, p.y, p.w, 6);

            // Grass detail
            ctx.fillStyle = '#4a7a4a';
            for (let i = 0; i < p.w; i += 20) {
                ctx.fillRect(p.x + i + 8, p.y + 14, 4, 4);
            }
        }

        function drawBrick(p) {
            // Main brick color
            ctx.fillStyle = '#8b6b4a';
            ctx.fillRect(p.x, p.y, p.w, p.h);

            // Highlight
            ctx.fillStyle = '#a88b6a';
            ctx.fillRect(p.x, p.y, p.w, 4);
            ctx.fillRect(p.x, p.y, 4, p.h);

            // Shadow
            ctx.fillStyle = '#6b5040';
            ctx.fillRect(p.x + p.w - 4, p.y, 4, p.h);
            ctx.fillRect(p.x, p.y + p.h - 4, p.w, 4);
        }

        function drawQuestionBlock(block) {
            const x = block.x;
            const y = block.y + (block.bounceY || 0);
            const w = block.w;
            const h = block.h;

            if (block.hit) {
                // Used block (grey/dull)
                ctx.fillStyle = '#5a5a5a';
                ctx.fillRect(x, y, w, h);

                ctx.fillStyle = '#6a6a6a';
                ctx.fillRect(x + 3, y + 3, w - 6, 3);
                ctx.fillRect(x + 3, y + 3, 3, h - 6);

                ctx.fillStyle = '#4a4a4a';
                ctx.fillRect(x + w - 5, y + 3, 2, h - 6);
                ctx.fillRect(x + 3, y + h - 5, w - 6, 2);
            } else {
                // Glow for rare blocks
                if (block.itemType === 'rare') {
                    ctx.shadowColor = '#ffd93d';
                    ctx.shadowBlur = 20;
                }

                // Active question block (golden)
                ctx.fillStyle = '#ffd93d';
                ctx.fillRect(x, y, w, h);

                // Highlights
                ctx.fillStyle = '#ffeb8a';
                ctx.fillRect(x + 3, y + 3, w - 6, 4);
                ctx.fillRect(x + 3, y + 3, 4, h - 6);

                // Shadows
                ctx.fillStyle = '#c9a227';
                ctx.fillRect(x + w - 6, y + 3, 3, h - 6);
                ctx.fillRect(x + 3, y + h - 6, w - 6, 3);

                // Question mark
                ctx.fillStyle = '#8b6914';
                ctx.font = 'bold 22px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('?', x + w/2, y + h - 10);

                ctx.shadowBlur = 0;
            }
        }

        function drawSpawnedItem(item) {
            // Glow effect for rare items
            if (item.glow) {
                ctx.shadowColor = item.color;
                ctx.shadowBlur = 15;
            }

            // Item background
            ctx.fillStyle = '#fff';
            ctx.fillRect(item.x, item.y, item.w, item.h);

            // Colored center
            ctx.fillStyle = item.color;
            ctx.fillRect(item.x + 4, item.y + 4, item.w - 8, item.h - 8);

            // Letter/icon
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(item.name[0], item.x + item.w/2, item.y + item.h/2 + 5);

            ctx.shadowBlur = 0;
        }

        function drawEndDoor() {
            const x = endDoor.x;
            const y = endDoor.y;
            const w = endDoor.w;
            const h = endDoor.h;

            // Glow
            ctx.shadowColor = '#6bcb77';
            ctx.shadowBlur = 25;

            // Door frame
            ctx.fillStyle = '#6bcb77';
            ctx.fillRect(x - 6, y - 12, w + 12, h + 12);

            ctx.shadowBlur = 0;

            // Door body
            ctx.fillStyle = '#2d5a3d';
            ctx.fillRect(x, y, w, h);

            // Door highlight
            ctx.fillStyle = '#4a8c5a';
            ctx.fillRect(x + 5, y + 5, 18, h - 10);

            // Door handle
            ctx.fillStyle = '#ffd93d';
            ctx.fillRect(x + w - 18, y + h/2 - 5, 8, 10);

            // Text
            ctx.fillStyle = '#fff';
            ctx.font = '8px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText("WHAT'S", x + w/2, y + 35);
            ctx.fillText('NEXT?', x + w/2, y + 50);
        }

        // ========================================
        // GAME LOOP
        // ========================================

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Start the game loop
        gameLoop();
    </script>
</body>
</html>
